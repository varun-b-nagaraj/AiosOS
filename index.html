<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Generate Plan / Deep Dive Stream Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    textarea, input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      border-radius: 6px;
      font-family: monospace;
    }

    button {
      padding: 10px 14px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 8px;
    }

    button.secondary {
      background: #475569;
    }

    pre {
      background: #020617;
      border: 1px solid #334155;
      padding: 12px;
      border-radius: 6px;
      height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      font-size: 13px;
    }

    .row {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>

<h1>AI Generate Plan / Deep Dive Stream Tester</h1>

<label>User ID</label>
<input id="userId" value="3795457e-b828-4f2d-807d-f9584c680b44" />

<label>Company Name</label>
<input id="companyName" value="TestCo" />

<label>Company Title</label>
<input id="companyTitle" value="Founder" />

<label>Short Description</label>
<textarea id="shortDescription">A CRM add-on that auto-triages inbound email into contacts, tasks, and notes.</textarea>

<div class="row">
  <button onclick="runGeneratePlan()">Generate Plan (Stream)</button>
  <button class="secondary" onclick="clearOutput()">Clear</button>
</div>

<hr style="margin:20px 0; border-color:#334155" />

<label>Plan ID (for Deep Dive)</label>
<input id="planId" placeholder="Paste plan_id here" />

<label>Step Key</label>
<input id="stepKey" value="step_1" />

<div class="row">
  <button onclick="runDeepDive()">Deep Dive (Stream)</button>
</div>

<h3>Stream Output</h3>
<pre id="output"></pre>

<script>
const ENDPOINT = "http://127.0.0.1:54321/functions/v1/ai-generate-plan";

function clearOutput() {
  document.getElementById("output").textContent = "";
}

function append(text) {
  const out = document.getElementById("output");
  out.textContent += text;
  out.scrollTop = out.scrollHeight;
}

async function streamRequest(payload) {
  const res = await fetch(ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  if (!res.ok || !res.body) {
    append(`\nERROR: HTTP ${res.status}\n`);
    return;
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });

    let idx;
    while ((idx = buffer.indexOf("\n\n")) !== -1) {
      const frame = buffer.slice(0, idx);
      buffer = buffer.slice(idx + 2);

      let event = "message";
      let data = "";

      for (const line of frame.split("\n")) {
        if (line.startsWith("event:")) event = line.slice(6).trim();
        if (line.startsWith("data:")) data += line.slice(5).trim();
      }

      if (!data) continue;

      const parsed = JSON.parse(data);

      if (event === "token") {
        append(parsed.delta ?? "");
      } else if (event === "status") {
        append(`\n\n[STATUS] ${JSON.stringify(parsed)}\n`);
        if (parsed.plan_id) {
          document.getElementById("planId").value = parsed.plan_id;
        }
      } else if (event === "done") {
        append(`\n\n[DONE]\n${JSON.stringify(parsed, null, 2)}\n`);
      } else if (event === "error") {
        append(`\n\n[ERROR]\n${JSON.stringify(parsed, null, 2)}\n`);
      }
    }
  }
}

function runGeneratePlan() {
  clearOutput();

  streamRequest({
    mode: "generate_plan_stream",
    user_id: document.getElementById("userId").value.trim(),
    company_name: document.getElementById("companyName").value.trim(),
    company_title: document.getElementById("companyTitle").value.trim(),
    short_description: document.getElementById("shortDescription").value.trim(),
  });
}

function runDeepDive() {
  clearOutput();

  streamRequest({
    mode: "deep_dive_stream",
    plan_id: document.getElementById("planId").value.trim(),
    step_key: document.getElementById("stepKey").value.trim(),
  });
}
</script>

</body>
</html>
